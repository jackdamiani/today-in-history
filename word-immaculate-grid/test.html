<!DOCTYPE html>
<html lang="en">
<head>
    <title>Word Immaculate Grid</title>
    <meta name="description" content="Fill in all 16 squares in the word immaculate grid!" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="style.css">
    <script src="dictionary.js"></script>
    <script src="category_translation.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh; /* Full viewport height */
            display: flex;
            flex-direction: column; /* Align items vertically */
            align-items: center; /* Center horizontally */
            justify-content: flex-start; /* Align at the top */
            font-family: Arial, sans-serif; /* Optional: Set a nice font */
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            max-width: 400px;
        }

        #game-selector {
            display: flex;
            flex-direction: row; /* Stack buttons vertically */
            align-items: center;
            gap: 10px; /* Space between buttons */
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            width: 150px; /* Make buttons uniform */
        }

        button:hover {
            background-color: #ddd;
        }

        .autocomplete-suggestions {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            z-index: 1000;
            max-width: 300px;
        }

        .autocomplete-suggestions div {
            padding: 5px;
            cursor: pointer;
        }

        .autocomplete-suggestions div:hover {
            background-color: #eee;
        }

        /* For a successful word (valid) */
        .valid {
            background-color: green;
            color: white;
        }

        /* For a failed word (invalid) */
        .invalid {
            background-color: red;
            color: white;
        }

    </style>
</head>
<body>
    <h1>Word Immaculate Grid</h1>
    <p> How to play: Fill in each square with any English word <br> so that the word fits in both the vertical and horizontal categories</p>
    <p> You are part of the beta testers of the game! Thank you!<br> Please send any feedback to Jack at jack@today-in-history-game.com </p>

    <!-- <button onclick="checkWord('ant', 'noun', '3letters')">Check Word</button> -->

    <h2>Select a Game</h2>
    <div id="game-selector">
        
        <button onclick="selectGame(1)">Game 1</button>
        <button onclick="selectGame(2)">Game 2</button>
        <button onclick="selectGame(3)">Game 3</button>
    </div>

    <div class="grid" id="grid"></div>

    <div id="autocomplete" class="autocomplete-suggestions" style="display: none;"></div>

    <script>
        
        let top1, top2, top3, side1, side2, side3;
        const games = {
            1: ["noun", "verb", "adjective", "3letters", "4letters", "5letters"],
            2: ["Category 2A", "Category 2B", "Category 2C", "Category 2D", "Category 2E", "Category 2F"],
            3: ["5letters", "6letters", "all5_vowels", "double_letter", "start_end_same_letter", "no_repeated_letters"]
        };

        let gameNumber;

        

        // Function to select a game and display translated categories
        function selectGame(selectedGame) {            
            gameNumber = selectedGame
            // Assign categories based on game selection
            const selectedCategories = games[gameNumber];
            [top1, top2, top3, side1, side2, side3] = selectedCategories;

            generateGrid(gameNumber);
        }

        // Function to display translated categories on the grid
        function displayCategories() {
            const categoryElements = {
                top1: document.getElementById('top1'),
                top2: document.getElementById('top2'),
                top3: document.getElementById('top3'),
                side1: document.getElementById('side1'),
                side2: document.getElementById('side2'),
                side3: document.getElementById('side3')
            };

            // Update category elements with translations
            Object.entries(categoryElements).forEach(([key, element]) => {
                const category = eval(key); // Use variable name to get value
                const translation = categoryTranslations[category] || category; // Fallback to the original if no translation
                element.textContent = translation;
            });
        }

        function generateGrid(gameNumber) {
            const gridContainer = document.getElementById("grid");
            gridContainer.innerHTML = ""; // Clear existing grid

            // Fetch categories for the selected game number
            const categories = games[gameNumber];

            // Use the first 3 categories for top and the next 3 for side
            const topCategories = categories.slice(0, 3);
            const sideCategories = categories.slice(3, 6);

            // Row 0: Blank and top categories
            const topRow = document.createElement("div");
            topRow.classList.add("grid-row");

            // Create top category cells (e.g., top1, top2, top3)
            topCategories.forEach((category, index) => {
                const cell = createCell(category);
                cell.id = `top${index + 1}`; // Add unique ID for each top category (top1, top2, top3)
                topRow.appendChild(cell);
            });
            gridContainer.appendChild(topRow);

            // Create the side rows (side categories)
            sideCategories.forEach((sideCategory, rowIndex) => {
                const row = document.createElement("div");
                row.classList.add("grid-row");

                // Create the side category cell (e.g., side1, side2, side3)
                const sideCell = createCell(sideCategory);
                sideCell.id = `side${rowIndex + 1}`; // Add unique ID for each side category (side1, side2, side3)
                row.appendChild(sideCell);

                // Create input fields for each column (based on top categories)
                topCategories.forEach((topCategory, colIndex) => {
                    const input = document.createElement("input");
                    input.setAttribute("type", "text");
                    input.setAttribute("maxlength", "20");
                    input.setAttribute("data-row", rowIndex + 1);
                    input.setAttribute("data-col", colIndex + 1);
                    // input.setAttribute("data-cell", i);
                    input.addEventListener("input", showAutocomplete);
                    input.addEventListener("keydown", handleInputChange);
                    row.appendChild(input);
                });

                gridContainer.appendChild(row);
            });

            // Call displayCategories after grid generation
            displayCategories();
        }


        // Function to handle input change when "Enter" is pressed
        async function handleInputChange(event) {
            let wordValid = 0
            const inputField = event.target;

                // **Trigger only when "Enter" key is pressed**
                if (event.key === "Enter") {
                    let rowIndex = inputField.dataset.col; // Get the row from data-row
                    let colIndex = inputField.dataset.row; // Get the column from data-col
                    const word = inputField.value; // Get the word entered by the user
                    rowIndex = parseInt(rowIndex);
                    colIndex = parseInt(colIndex);

                    console.log(rowIndex, colIndex);

                    // Assuming categories are passed dynamically or set
                    let { sideCategory: category1, topCategory: category2 } = getCategoriesIndex(rowIndex, colIndex);

                    // Call checkWord to validate the input
                    console.log(word, category1, category2)
                    try {
                        wordValid = await checkWord(word, category1, category2);
                        console.log(wordValid); // Logs 1 or 0 based on the server response
                    } catch (error) {
                        console.error('Error:', error); // Catch errors
                    }
            console.log(rowIndex,colIndex, wordValid)
            updateCellColor(rowIndex, colIndex, wordValid)

            }
        }

        function updateCellColor(rowIndex_flip, colIndex_flip, isValid) {
            // Find the input element based on row and column indices
            const inputField = document.querySelector(
                `input[data-row="${colIndex_flip}"][data-col="${rowIndex_flip}"]`
            );

            if (inputField) {
                // Apply the appropriate class based on the validity
                if (isValid) {
                    inputField.classList.add('valid');
                    inputField.classList.remove('invalid');
                } else {
                    inputField.classList.add('invalid');
                    inputField.classList.remove('valid');
                }
            }
        }

            





        function getCategoriesIndex(rowIndex, colIndex) {
            // Adjusting indices for 1-based indexing
            const sideCategoryIndex = rowIndex - 1; // Adjust row index for side categories (side1, side2, side3)
            const topCategoryIndex = colIndex + 2;  // Adjust column index for top categories (top1, top2, top3)

            // Get the values from the games dictionary based on the adjusted indices
            let sideCategory = games[gameNumber][sideCategoryIndex];  // Side category
            let topCategory = games[gameNumber][topCategoryIndex];    // Top category

            return { sideCategory, topCategory };
        }

    

        // Add event listener to handle input event for "Enter" key
        document.querySelectorAll("input").forEach(input => {
            input.addEventListener("input", handleInputChange); // Detect when Enter is pressed
        });


        function createCell(content) {
            const cell = document.createElement("div");
            cell.textContent = content;
            cell.style.fontWeight = "bold";
            return cell;
        }

        const autocompleteDiv = document.getElementById("autocomplete");

        function showAutocomplete(event) {
            const query = event.target.value.toLowerCase();
            const inputRect = event.target.getBoundingClientRect();

            if (query.length === 0) {
                autocompleteDiv.style.display = "none";
                return;
            }

            // Filter words that match the query
            const matches = Object.keys(words_dict)
                .filter((word) => word.startsWith(query))
                .slice(0, 5);

            if (matches.length > 0) {
                autocompleteDiv.style.display = "block";
                autocompleteDiv.style.left = `${inputRect.left + window.scrollX}px`;
                autocompleteDiv.style.top = `${inputRect.bottom + window.scrollY}px`;

                // Clear previous suggestions
                autocompleteDiv.innerHTML = "";

                // Add suggestions to the autocomplete div
                matches.forEach((match) => {
                    const suggestion = document.createElement("div");
                    suggestion.textContent = match;
                    suggestion.addEventListener("click", () => {
                        event.target.value = match;
                        autocompleteDiv.style.display = "none";
                    });
                    autocompleteDiv.appendChild(suggestion);
                });
            } else {
                autocompleteDiv.style.display = "none";
            }
        }

        // Hide autocomplete when clicking outside
        document.addEventListener("click", (e) => {
            if (!autocompleteDiv.contains(e.target)) {
                autocompleteDiv.style.display = "none";
            }
        });


        async function checkWord(word, category1, category2) {
            return new Promise((resolve, reject) => {
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "check_word.php", true);
                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

                // Prepare the data to send
                var params = "word=" + encodeURIComponent(word) + "&category1=" + encodeURIComponent(category1) + "&category2=" + encodeURIComponent(category2);

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        var data = JSON.parse(xhr.responseText);
                        console.log(data); // Log the entire response
                        var data = JSON.parse(xhr.responseText);
                        if (data.status === 'success') {
                            console.log('success');
                            resolve(1);
                        } else {
                            console.log('fail');
                            resolve(0);
                        }
                    }
                };

                xhr.onerror = function () {
                    reject(new Error("Request failed"));
                };

                // Send the data
                xhr.send(params);
            });
        }





    </script>
</body>
</html>
